# AutoFilter JPA

This is a Java library that extends the [AutoFilter](https://github.com/XiriusTech/auto-filter) library to allow the use of the automatically generated filters to perform database queries using JPA.


## Usage/Examples

A full example of usage can be found [here.](https://github.com/XiriusTech/java-learning/tree/main/auto-filter)

#### Creating queries
Let's start with the following entity and filter created by Auto Filter:

```java
@AutoFilter
@Entity
public class Person {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    @Enumerated(EnumType.STRING)
    private Region userRegion;
}

public class PersonFilter implements Filter {
    private BasicFilter<Long> id;
    private RegionFilter userRegion;
    ...
    public static class RegionFilter extends BasicFilter<Region> {

    }
}
```

If you use Spring you can easily implement a Specification to perform queries to the database using the QueryBuilderProcessor:

```java
public class PersonSpecification implements Specification<Person> {
    private final PersonFilter filter;

    public PersonSpecification(PersonFilter filter) {
        super();
        this.filter = filter;
    }

    @Override
    public Predicate toPredicate(Root<Person> root, CriteriaQuery<?> query, CriteriaBuilder criteriaBuilder) {
        List<Predicate> listP = new ArrayList<>();

        QueryBuilderProcessor processor = new QueryBuilderProcessor(criteriaBuilder);

        listP.addAll(processor.createPredicates(root.get(Person_.id), filter.getId()));
        listP.addAll(processor.createPredicates(root.get(Person_.userRegion), filter.getUserRegion()));
        
        return criteriaBuilder.and(listP.toArray(new Predicate[0]));
    }
}
```

To use this Specification you need a Repository that implements JpaSpecificationExecutor:

```java
public interface PersonRepository extends JpaSpecificationExecutor<Person>, JpaRepository<Person, Long> {
}
```

You can use this specification with the repository like this:

```
Specification<Person> spec = new PersonSpecification(filter);
personRepository.findAll(spec, pageable);
```

This will create a query that will combine all the requested conditions. For example if the query is:
```
https://localhost:8080/persons?id.equals=1&userRegion.in=AMERICA,EUROPE
```
Then the resulting SQL generated by the specification will be equivalent to:
```SQL
SELECT * FROM Person
WHERE id = 1
AND region IN ("AMERICA", "EUROPE");
```

If you don't use Spring you can still use the QueryBuilderProcessor, as it doesn't have any direct dependency with Spring.

#### The QueryBuilder

A QueryBuilder is the responsible for processing a Filter and generating the corresponding JPA Criteria.

A Filter may contain subfilters, for example, BasicFilter contains an EqualFilter, InFilter and IsNullFilter. Each one of this filters has its own QueryBuilder.

Finally, as multiple QueryBuilders may intervene to create a full query, the QueryBuilderProcessor is used to coordinate the whole process, as seen in the image:

![AutoFilter JPA - Sequence Diagram](https://user-images.githubusercontent.com/17957661/221467795-daab31da-c67f-49b3-a737-90050d5177d8.png)

#### Creating a custom QueryBuilder

Let's say you create your own new filter. This will be the LikeBeginningFilter:

```java
public class LikeBeginningFilter implements SingleFilter<String> {
    private String value = null;
    ...
}
```

Now you need to create a QueryBuilder for this filter:

```java
@AutoService(QueryBuilder.class)
public class LikeBeginningFilterQueryBuilder implements QueryBuilder {
    @Override
    public <T extends Comparable<? super T>> List<Predicate> createPredicates(
            QueryBuilderProcessor processor, Expression<T> x, Filter filter) {
        if (filter instanceof LikeBeginningFilter) {
            return Arrays.asList(processor.getCriteriaBuilder()
                    .like(x, ((LikeBeginningFilter) filter).getValue() + "%"));
        }
        return null;
    }
}
```

The ```@AutoService(QueryBuilder.class)``` (from [Google AutoService](https://github.com/google/auto/tree/main/service)) annotation is added so that the QueryBuilder is automatically registered and detected by the QueryBuilderProcessor. However, you can also register a QueryBuilder during runtime by using the ```QueryBuilderProcessor.registerQueryBuilder(...)``` method.

Please note that new custom QueryBuilders should **NOT** be required for new implementations of ```MultiFilter```.
## Installation

You may install the library by including this dependency in your maven project:

```xml
<dependency>
    <groupId>tech.xirius</groupId>
    <artifactId>auto-filter-jpa</artifactId>
    <version>0.1.0</version>
</dependency>
```

Finally, to make use of the JPA integration it's strongly encouraged to have activated the static metamodel generation and Google AutoService: 
```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>${maven.version}</version>
            <configuration>
                <source>${java.version}</source>
                <target>${java.version}</target>
                <annotationProcessorPaths>
                    <path>
                        <groupId>org.hibernate</groupId>
                        <artifactId>hibernate-jpamodelgen</artifactId>
                        <version>${hibernate.version}</version>
                    </path>
                    <path>
                        <groupId>com.google.auto.service</groupId>
                        <artifactId>auto-service</artifactId>
                        <version>${auto-service.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
    </plugins>
</build>
```

    
## Feedback

If you have any feedback, please reach out to us by sending an email to tecnologia@xirius.tech.


## Contributing

For now, only members of Xirius Tech may contribute to this project, but this may change in the future.

However, you are free to fork the project and perform your own changes there under the provided license of this software.


## ðŸš€ About Xirius Tech
Xirius Tech is a company based in Latin America dedicated to the creation of web applications aimed to automate the processes that the client request. To do this we employ traditional technologies like Java and Spring Boot, and mix them with cutting edge advancements in Machine Learning to achieve the best results.

Visit us at [Xirius Tech](https://xirius.tech/) or send us an email directly to tecnologia@xirius.tech.


## Authors

- [@XiriusTech](https://github.com/XiriusTech)
- [@camilonar](https://www.github.com/camilonar)


## License

[Apache 2.0](https://www.apache.org/licenses/LICENSE-2.0)